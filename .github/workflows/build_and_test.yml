name: Python package

on: [push]

jobs:
  build:

    runs-on:  ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: [3.7, 3.8]
        
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Add conda ${{ matrix.python-version }} to system path
      run: |
        # $CONDA is an environment variable pointing to the root of the miniconda directory
        echo $CONDA/bin >> $GITHUB_PATH
        
    - name: Initialize conda ${{ matrix.python-version }}
      run: |
        conda install -y conda-build
        conda config --add channels conda-forge

    - name: Init Env
      run: |
        # Make sure we fail in case of errors
        set -e

        # Copy sources (we do not have write permission on the mounted $TRAVIS_BUILD_DIR),
        # so let's make a copy of the source code
        cd ~
        rm -rf my_work_dir
        mkdir my_work_dir
        # Copy also dot files (.*)
        shopt -s dotglob
        cp -R ${GITHUB_WORKSPACE}/* my_work_dir/

        cd my_work_dir

        if [[ ${{matrix.os}} == ubuntu0latest ]];
        then
        miniconda_os=Linux
        compilers="gcc_linux-64 gxx_linux-64 gfortran_linux-64"
        else  # osx
        miniconda_os=MacOSX
        compilers="clang_osx-64 clangxx_osx-64 gfortran_osx-64"

        # On macOS we also need the conda libx11 libraries used to build xspec
        # We also need to pin down ncurses, for now only on macos.
        xorg="xorg-libx11"
        fi

        # Get the version in the __version__ environment variable
        #python ci/set_minor_version.py --patch $TRAVIS_BUILD_NUMBER --version_file threeML/version.py

        #export PKG_VERSION=$(cd threeML && python -c "import version;print(version.__version__)")

        export PKG_VERSION=$(python -c "import versioneer;print(versioneer.get_version())")

        echo "HOME= ${HOME}"
        echo "Building ${PKG_VERSION} ..."
        echo "Python version: ${TRAVIS_PYTHON_VERSION}"

        #libgfortranver="3.0"
        #NUMPYVER=1.15
        MATPLOTLIBVER=2
        XSPECVER="6.25"
        xspec_channel=xspecmodels

        echo "Building ${PKG_VERSION} ..."
        echo "Python version: ${TRAVIS_PYTHON_VERSION}"

        conda update --yes -q conda conda-build

        conda config --add channels ${xspec_channel}



<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>threeML.classicMLE.joint_likelihood &mdash; The Multi-Mission Maximum Likelihood framework  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/dark_mode_css/general.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/dark_mode_css/dark.css" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
        <script src="../../../_static/dark_mode_js/default_dark.js"></script>
        <script src="../../../_static/dark_mode_js/theme_switcher.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            The Multi-Mission Maximum Likelihood framework
              <img src="../../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Intro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/logging.html">Logging and Verbosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xspec_users.html">Notes for XSPEC Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Minimization_tutorial.html">Minimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Bayesian_tutorial.html">Bayesian Posterior Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/sampler_docs.html">Bayesian Sampler Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modeling.html">Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/API.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/API.html#threeml">threeML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">Release Notes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Features and examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Analysis_results_showcase.html">Analysis Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/random_variates.html">Random Variates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Point_source_plotting.html">Point source plotting basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Building_Plugins_from_TimeSeries.html">Constructing plugins from TimeSeries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/grb080916C.html">Analyzing GRB 080916C</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/APEC_doc.html">Fitting XMM-Newton data with the APEC model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/joint_BAT_gbm_demo.html">Example joint fit between GBM and Swift BAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/joint_fitting_xrt_and_gbm_xspec_models.html">Joint fitting XRT and GBM data with XSPEC models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/flux_examples.html">Point Source Fluxes and Multiple Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Fermipy_LAT.html">Fermi-LAT via FermiPyLike</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Time-energy-fit.html">Time-energy fit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/synthetic_spectra.html">Generating Synthetic Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/gof_lrt.html">Goodness of Fit and Model Comparison</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">The Multi-Mission Maximum Likelihood framework</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../threeML.html">threeML</a></li>
      <li class="breadcrumb-item active">threeML.classicMLE.joint_likelihood</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for threeML.classicMLE.joint_likelihood</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">object</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">zip</span>

<span class="kn">import</span> <span class="nn">astromodels.core.model</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colormaps</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>
<span class="kn">from</span> <span class="nn">astromodels</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ModelAssertionViolation</span><span class="p">,</span> <span class="n">clone_model</span>
<span class="kn">from</span> <span class="nn">past.utils</span> <span class="kn">import</span> <span class="n">old_div</span>

<span class="kn">from</span> <span class="nn">threeML.analysis_results</span> <span class="kn">import</span> <span class="n">MLEResults</span>
<span class="kn">from</span> <span class="nn">threeML.config.config</span> <span class="kn">import</span> <span class="n">threeML_config</span>
<span class="kn">from</span> <span class="nn">threeML.data_list</span> <span class="kn">import</span> <span class="n">DataList</span>
<span class="kn">from</span> <span class="nn">threeML.exceptions</span> <span class="kn">import</span> <span class="n">custom_exceptions</span>
<span class="kn">from</span> <span class="nn">threeML.exceptions.custom_exceptions</span> <span class="kn">import</span> <span class="n">FitFailed</span><span class="p">,</span> <span class="n">custom_warnings</span><span class="p">,</span>\
    <span class="n">NoFitYet</span><span class="p">,</span> <span class="n">MinLargerMax</span><span class="p">,</span> <span class="n">ForbiddenRegionOfParameterSpace</span><span class="p">,</span> <span class="n">MinimizerNotAvailable</span>
<span class="kn">from</span> <span class="nn">threeML.io.logging</span> <span class="kn">import</span> <span class="n">setup_logger</span>
<span class="kn">from</span> <span class="nn">threeML.io.package_data</span> <span class="kn">import</span> <span class="n">get_path_of_data_file</span>
<span class="kn">from</span> <span class="nn">threeML.io.results_table</span> <span class="kn">import</span> <span class="n">ResultsTable</span>
<span class="kn">from</span> <span class="nn">threeML.io.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">threeML.minimizer</span> <span class="kn">import</span> <span class="n">minimization</span>
<span class="kn">from</span> <span class="nn">threeML.parallel.parallel_client</span> <span class="kn">import</span> <span class="n">ParallelClient</span>
<span class="kn">from</span> <span class="nn">threeML.utils.statistics.stats_tools</span> <span class="kn">import</span> <span class="n">aic</span><span class="p">,</span> <span class="n">bic</span>

<span class="k">if</span> <span class="n">threeML_config</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">use_threeml_style</span><span class="p">:</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">get_path_of_data_file</span><span class="p">(</span><span class="s2">&quot;threeml.mplstyle&quot;</span><span class="p">)))</span>


<span class="n">log</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ReducingNumberOfThreads"><a class="viewcode-back" href="../../../notebooks/api/threeML.classicMLE.html#threeML.classicMLE.joint_likelihood.ReducingNumberOfThreads">[docs]</a><span class="k">class</span> <span class="nc">ReducingNumberOfThreads</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="ReducingNumberOfSteps"><a class="viewcode-back" href="../../../notebooks/api/threeML.classicMLE.html#threeML.classicMLE.joint_likelihood.ReducingNumberOfSteps">[docs]</a><span class="k">class</span> <span class="nc">ReducingNumberOfSteps</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="NotANumberInLikelihood"><a class="viewcode-back" href="../../../notebooks/api/threeML.classicMLE.html#threeML.classicMLE.joint_likelihood.NotANumberInLikelihood">[docs]</a><span class="k">class</span> <span class="nc">NotANumberInLikelihood</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="JointLikelihood"><a class="viewcode-back" href="../../../notebooks/api/threeML.classicMLE.html#threeML.classicMLE.joint_likelihood.JointLikelihood">[docs]</a><span class="k">class</span> <span class="nc">JointLikelihood</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">likelihood_model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
        <span class="n">data_list</span><span class="p">:</span> <span class="n">DataList</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">record</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implement a joint likelihood analysis.</span>

<span class="sd">        :param likelihood_model: the model for the likelihood analysis</span>
<span class="sd">        :param data_list: the list of data sets (plugin instances) to be used in this analysis</span>
<span class="sd">        :param verbose: (True or False) print every step in the -log likelihood minimization</span>
<span class="sd">        :param record: it records every call to the log likelihood function during minimization. The recorded values</span>
<span class="sd">        can be retrieved as a pandas DataFrame using the .fit_trace property</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;creating new MLE analysis&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mle&quot;</span>

        <span class="c1"># Process optional keyword parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="n">likelihood_model</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data_list</span><span class="p">:</span> <span class="n">DataList</span> <span class="o">=</span> <span class="n">data_list</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_model_to_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="p">)</span>

        <span class="c1"># This is to keep track of the number of calls to the likelihood</span>
        <span class="c1"># function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ncalls</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record_calls</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Pre-defined minimizer</span>
        <span class="n">default_minimizer</span> <span class="o">=</span> <span class="n">minimization</span><span class="o">.</span><span class="n">LocalMinimization</span><span class="p">(</span>
            <span class="n">threeML_config</span><span class="p">[</span><span class="s2">&quot;mle&quot;</span><span class="p">][</span><span class="s2">&quot;default_minimizer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">threeML_config</span><span class="p">[</span><span class="s2">&quot;mle&quot;</span><span class="p">][</span><span class="s2">&quot;default_minimizer_algorithm&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">default_minimizer</span><span class="o">.</span><span class="n">set_algorithm</span><span class="p">(</span>
                <span class="n">threeML_config</span><span class="p">[</span><span class="s2">&quot;mle&quot;</span><span class="p">][</span><span class="s2">&quot;default_minimizer_algorithm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_minimizer</span><span class="p">(</span><span class="n">default_minimizer</span><span class="p">)</span>

        <span class="c1"># Initial set of free parameters</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_free_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="o">.</span><span class="n">free_parameters</span>

        <span class="c1"># Initially set the value of _current_minimum to None, it will be change by the fit() method</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_current_minimum</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Null setup for minimizer</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer_callback</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_assign_model_to_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;REGISTERING MODEL&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_list</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>

            <span class="n">dataset</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

            <span class="c1"># Now get the nuisance parameters from the data and add them to the model</span>
            <span class="c1"># NOTE: it is important that this is *after* the setting of the model, as some</span>
            <span class="c1"># plugins might need to adjust the number of nuisance parameters depending on the</span>
            <span class="c1"># likelihood model</span>

            <span class="k">for</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">nuisance_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="c1"># Enforce that the nuisance parameter contains the instance name, because otherwise multiple instance</span>
                <span class="c1"># of the same plugin will overwrite each other&#39;s nuisance parameters</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">parameter_name</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;This is a bug of the plugin for </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">: &quot;</span>
                        <span class="s2">&quot;nuisance parameters must contain the instance name&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">NameError</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="o">.</span><span class="n">add_external_parameter</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;MODEL REGISTERED!&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">likelihood_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Model</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: likelihood model for this analysis</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataList</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: data list for this analysis</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_list</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_minimum</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: current minimum of the joint likelihood (available only after the fit() method)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_minimum</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">minimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: an instance of the minimizer used in the fit (available only after the fit() method)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">covariance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: covariance matrix from the last fit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer</span><span class="o">.</span><span class="n">covariance_matrix</span>

        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>

            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;You need to run a fit before accessing the covariance matrix&quot;</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">correlation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: correlation matrix from the last fit</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer</span><span class="o">.</span><span class="n">correlation_matrix</span>

        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>

            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;You need to run a fit before accessing the correlation matrix&quot;</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">analysis_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_type</span>

    <span class="k">def</span> <span class="nf">_update_free_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the dictionary of free parameters&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_free_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="o">.</span><span class="n">free_parameters</span>

<div class="viewcode-block" id="JointLikelihood.fit"><a class="viewcode-back" href="../../../notebooks/api/threeML.classicMLE.html#threeML.classicMLE.joint_likelihood.JointLikelihood.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">quiet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">compute_covariance</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a fit of the current likelihood model on the datasets</span>

<span class="sd">        :param quiet: If True, print the results (default), otherwise do not print anything</span>
<span class="sd">        :param compute_covariance:If True (default), compute and display the errors and the correlation matrix.</span>
<span class="sd">        :param n_samples: Number of samples to scan the likelihood.</span>
<span class="sd">        :return: a dictionary with the results on the parameters, and the values of the likelihood at the minimum</span>
<span class="sd">                 for each dataset and the total one.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Update the list of free parameters, to be safe against changes the user might do between</span>
        <span class="c1"># the creation of this class and the calling of this method</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;beginning the fit!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_free_parameters</span><span class="p">()</span>

        <span class="c1"># Empty the call recorder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record_calls</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ncalls</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Check if we have free parameters, otherwise simply return the value of the log like</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_free_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;There is no free parameter in the current model&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Store the &quot;minimum&quot;, which is just the current value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_minimum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minus_log_like_profile</span><span class="p">())</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Instance the minimizer</span>

            <span class="c1"># If we have a global minimizer, use that first (with no covariance)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_minimizer_type</span><span class="p">,</span> <span class="n">minimization</span><span class="o">.</span><span class="n">GlobalMinimization</span><span class="p">):</span>

                <span class="c1"># Do global minimization first</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;starting global optimization&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">quiet</span><span class="p">:</span>

                    <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="n">global_minimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_minimizer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">minus_log_like_profile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free_parameters</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span>
                <span class="p">)</span>

                <span class="n">xs</span><span class="p">,</span> <span class="n">global_log_likelihood_minimum</span> <span class="o">=</span> <span class="n">global_minimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
                    <span class="n">compute_covar</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

                <span class="c1"># Gather global results</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_free_parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>

                    <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>

                <span class="n">global_results</span> <span class="o">=</span> <span class="n">ResultsTable</span><span class="p">(</span>
                    <span class="n">paths</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Results after global minimizer (before secondary optimization):&quot;</span>
                    <span class="p">)</span>

                    <span class="n">global_results</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total log-likelihood minimum: </span><span class="si">%.3f</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="n">global_log_likelihood_minimum</span>
                    <span class="p">)</span>

                <span class="c1"># Now set up secondary minimizer</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer_type</span><span class="o">.</span><span class="n">get_second_minimization_instance</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">minus_log_like_profile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free_parameters</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># Only local minimization to be performed</span>

                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;starting local optimization&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_minimizer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">minus_log_like_profile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free_parameters</span>
                <span class="p">)</span>

            <span class="c1"># Perform the fit, but first flush stdout (so if we have verbose=True the messages there will follow</span>
            <span class="c1"># what is already in the buffer)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">xs</span><span class="p">,</span> <span class="n">log_likelihood_minimum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
                <span class="n">compute_covar</span><span class="o">=</span><span class="n">compute_covariance</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">log_likelihood_minimum</span> <span class="o">==</span> <span class="n">minimization</span><span class="o">.</span><span class="n">FIT_FAILED</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The fit failed to converge.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">FitFailed</span><span class="p">()</span>

            <span class="c1"># Store the current minimum for the -log likelihood</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_current_minimum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">log_likelihood_minimum</span><span class="p">)</span>

            <span class="c1"># First restore best fit (to make sure we compute the likelihood at the right point in the following)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer</span><span class="o">.</span><span class="n">restore_best_fit</span><span class="p">()</span>

        <span class="c1"># Now collect the values for the likelihood for the various datasets</span>

        <span class="c1"># Fill the dictionary with the values of the -log likelihood (dataset by dataset)</span>

        <span class="n">minus_log_likelihood_values</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

        <span class="c1"># Keep track of the total for a double check</span>

        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># sum up the total number of data points</span>

        <span class="n">total_number_of_data_points</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_list</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>

            <span class="n">ml</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">inner_fit</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">minus_log_likelihood_values</span><span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ml</span>

            <span class="n">total</span> <span class="o">+=</span> <span class="n">ml</span>

            <span class="n">total_number_of_data_points</span> <span class="o">+=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_number_of_data_points</span><span class="p">()</span>
            
            
        <span class="k">if</span> <span class="n">total</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_minimum</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Current minimum stored after fit (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_minimum</span><span class="si">}</span><span class="s2">) and current (</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">) do not correspond!&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>

        <span class="c1"># compute additional statistics measures</span>

        <span class="n">statistical_measures</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

        <span class="c1"># for MLE we can only compute the AIC and BIC as they</span>
        <span class="c1"># are point estimates</span>

        <span class="n">statistical_measures</span><span class="p">[</span><span class="s2">&quot;AIC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aic</span><span class="p">(</span>
            <span class="o">-</span><span class="n">total</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_free_parameters</span><span class="p">),</span> <span class="n">total_number_of_data_points</span>
        <span class="p">)</span>
        <span class="n">statistical_measures</span><span class="p">[</span><span class="s2">&quot;BIC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bic</span><span class="p">(</span>
            <span class="o">-</span><span class="n">total</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_free_parameters</span><span class="p">),</span> <span class="n">total_number_of_data_points</span>
        <span class="p">)</span>

        <span class="c1">#Workaround for the case of a &quot;fit&quot; with no free parameters</span>
        <span class="c1">#This happens e.g. if you calculate the TS of the only source</span>
        <span class="c1">#in a one-source model.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">covariance_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer</span><span class="o">.</span><span class="n">covariance_matrix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">covariance_matrix</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Now instance an analysis results class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span> <span class="o">=</span> <span class="n">MLEResults</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_model</span><span class="p">,</span>
            <span class="n">covariance_matrix</span><span class="p">,</span>
            <span class="n">minus_log_likelihood_values</span><span class="p">,</span>
            <span class="n">statistical_measures</span><span class="o">=</span><span class="n">statistical_measures</span><span class="p">,</span>
            <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Show the results</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="o">.</span><span class="n">get_data_frame</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="o">.</span><span class="n">get_statistic_frame</span><span class="p">(),</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MLEResults</span><span class="p">:</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span>

<div class="viewcode-block" id="JointLikelihood.get_errors"><a class="viewcode-back" href="../../../notebooks/api/threeML.classicMLE.html#threeML.classicMLE.joint_likelihood.JointLikelihood.get_errors">[docs]</a>    <span class="k">def</span> <span class="nf">get_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the errors on the parameters using the profile likelihood method.</span>

<span class="sd">        :return: a dictionary containing the asymmetric errors for each parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check that the user performed a fit first</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_minimum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                 <span class="s2">&quot;You have to run the .fit method before calling errors.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">NoFitYet</span><span class="p">()</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer</span><span class="o">.</span><span class="n">get_errors</span><span class="p">()</span>

        <span class="c1"># Set the parameters back to the best fit value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore_best_fit</span><span class="p">()</span>

        <span class="c1"># Print a table with the errors</span>

        <span class="n">parameter_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_free_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">best_fit_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_free_parameters</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
        <span class="n">negative_errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">errors</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">parameter_names</span><span class="p">]</span>
        <span class="n">positive_errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">errors</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">parameter_names</span><span class="p">]</span>
        <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">unit</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_free_parameters</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>

        <span class="n">results_table</span> <span class="o">=</span> <span class="n">ResultsTable</span><span class="p">(</span>
            <span class="n">parameter_names</span><span class="p">,</span> <span class="n">best_fit_values</span><span class="p">,</span> <span class="n">negative_errors</span><span class="p">,</span> <span class="n">positive_errors</span><span class="p">,</span> <span class="n">units</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>

            <span class="n">results_table</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">results_table</span><span class="o">.</span><span class="n">frame</span></div>

<div class="viewcode-block" id="JointLikelihood.get_contours"><a class="viewcode-back" href="../../../notebooks/api/threeML.classicMLE.html#threeML.classicMLE.joint_likelihood.JointLikelihood.get_contours">[docs]</a>    <span class="k">def</span> <span class="nf">get_contours</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">param_1</span><span class="p">,</span>
        <span class="n">param_1_minimum</span><span class="p">,</span>
        <span class="n">param_1_maximum</span><span class="p">,</span>
        <span class="n">param_1_n_steps</span><span class="p">,</span>
        <span class="n">param_2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">param_2_minimum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">param_2_maximum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">param_2_n_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">options</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate confidence contours for the given parameters by stepping for the given number of steps between</span>
<span class="sd">        the given boundaries. Call it specifying only source_1, param_1, param_1_minimum and param_1_maximum to</span>
<span class="sd">        generate the profile of the likelihood for parameter 1. Specify all parameters to obtain instead a 2d</span>
<span class="sd">        contour of param_1 vs param_2.</span>

<span class="sd">        NOTE: if using parallel computation, param_1_n_steps must be an integer multiple of the number of running</span>
<span class="sd">        engines. If that is not the case, the code will reduce the number of steps to match that requirement, and</span>
<span class="sd">        issue a warning</span>

<span class="sd">        :param param_1: fully qualified name of the first parameter or parameter instance</span>
<span class="sd">        :param param_1_minimum: lower bound for the range for the first parameter</span>
<span class="sd">        :param param_1_maximum: upper bound for the range for the first parameter</span>
<span class="sd">        :param param_1_n_steps: number of steps for the first parameter</span>
<span class="sd">        :param param_2: fully qualified name of the second parameter or parameter instance</span>
<span class="sd">        :param param_2_minimum: lower bound for the range for the second parameter</span>
<span class="sd">        :param param_2_maximum: upper bound for the range for the second parameter</span>
<span class="sd">        :param param_2_n_steps: number of steps for the second parameter</span>
<span class="sd">        :param progress: (True or False) whether to display progress or not</span>
<span class="sd">        :param log: by default the steps are taken linearly. With this optional parameter you can provide a tuple of</span>
<span class="sd">                    booleans which specify whether the steps are to be taken logarithmically. For example,</span>
<span class="sd">                    &#39;log=(True,False)&#39; specify that the steps for the first parameter are to be taken logarithmically,</span>
<span class="sd">                    while they are linear for the second parameter. If you are generating the profile for only one</span>
<span class="sd">                    parameter, you can specify &#39;log=(True,)&#39; or &#39;log=(False,)&#39; (optional)</span>
<span class="sd">        :return: a tuple containing an array corresponding to the steps for the first parameter, an array corresponding</span>
<span class="sd">                 to the steps for the second parameter (or None if stepping only in one direction), a matrix of size</span>
<span class="sd">                 param_1_steps x param_2_steps containing the value of the function at the corresponding points in the</span>
<span class="sd">                 grid. If param_2_steps is None (only one parameter), then this reduces to an array of</span>
<span class="sd">                 size param_1_steps.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">param_1</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">):</span>

            <span class="c1"># Substitute with the name</span>
            <span class="n">param_1</span> <span class="o">=</span> <span class="n">param_1</span><span class="o">.</span><span class="n">path</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">param_2</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">):</span>

            <span class="n">param_2</span> <span class="o">=</span> <span class="n">param_2</span><span class="o">.</span><span class="n">path</span>

        <span class="c1"># Check that the parameters exist</span>
        <span class="k">if</span> <span class="n">param_1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="o">.</span><span class="n">free_parameters</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter </span><span class="si">{</span><span class="n">param_1</span><span class="si">}</span><span class="s2"> is not a free parameters of the current model&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">()</span>


        <span class="k">if</span> <span class="n">param_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param_2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="o">.</span><span class="n">free_parameters</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Parameter </span><span class="si">{</span><span class="n">param_2</span><span class="si">}</span><span class="s2"> is not a free parameters of the &quot;</span>
                    <span class="s2">&quot;current model&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">()</span>

        <span class="c1"># Check that we have a valid fit</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_minimum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;You have to run the .fit method before calling get_contours.&quot;</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="n">NoFitYet</span><span class="p">()</span>

        <span class="c1"># Then restore the best fit</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer</span><span class="o">.</span><span class="n">restore_best_fit</span><span class="p">()</span>

        <span class="c1"># Check minimal assumptions about the procedure</span>

        <span class="k">if</span> <span class="n">param_1</span><span class="o">==</span><span class="n">param_2</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;You have to specify two different parameters&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">param_1_minimum</span><span class="o">&lt;</span><span class="n">param_1_maximum</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Minimum larger than maximum for parameter 1&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">MinLargerMax</span><span class="p">()</span>

        <span class="n">min1</span><span class="p">,</span> <span class="n">max1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_model</span><span class="p">[</span><span class="n">param_1</span><span class="p">]</span><span class="o">.</span><span class="n">bounds</span>

        <span class="k">if</span> <span class="n">min1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param_1_minimum</span> <span class="o">&lt;</span> <span class="n">min1</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Requested low range for parameter </span><span class="si">{</span><span class="n">param_1</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">param_1_minimum</span><span class="si">}</span><span class="s2">) is below parameter &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;minimum (</span><span class="si">{</span><span class="n">min1</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">ForbiddenRegionOfParameterSpace</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">max1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param_1_maximum</span> <span class="o">&gt;</span> <span class="n">max1</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Requested hi range for parameter </span><span class="si">{</span><span class="n">param_1</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">param_1_maximum</span><span class="si">}</span><span class="s2">) &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;is above parameter maximum (</span><span class="si">{</span><span class="n">max1</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">ForbiddenRegionOfParameterSpace</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">param_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">min2</span><span class="p">,</span> <span class="n">max2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_model</span><span class="p">[</span><span class="n">param_2</span><span class="p">]</span><span class="o">.</span><span class="n">bounds</span>

            <span class="k">if</span> <span class="n">min2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">param_2_minimum</span> <span class="o">&lt;</span> <span class="n">min2</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Requested low range for parameter </span><span class="si">{</span><span class="n">param_2</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;(param_2_minim) &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;is below parameter minimum (min2)&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ForbiddenRegionOfParameterSpace</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">max2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">param_2_maximum</span> <span class="o">&gt;</span> <span class="n">max2</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Requested hi range for parameter </span><span class="si">{</span><span class="n">param_2</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;(param_2_maximum) &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;is above parameter maximum (</span><span class="si">{</span><span class="n">max2</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ForbiddenRegionOfParameterSpace</span><span class="p">()</span>

        <span class="c1"># Check whether we are parallelizing or not</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">threeML_config</span><span class="p">[</span><span class="s2">&quot;parallel&quot;</span><span class="p">][</span><span class="s2">&quot;use_parallel&quot;</span><span class="p">]:</span>

            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">contours</span><span class="p">(</span>
                <span class="n">param_1</span><span class="p">,</span>
                <span class="n">param_1_minimum</span><span class="p">,</span>
                <span class="n">param_1_maximum</span><span class="p">,</span>
                <span class="n">param_1_n_steps</span><span class="p">,</span>
                <span class="n">param_2</span><span class="p">,</span>
                <span class="n">param_2_minimum</span><span class="p">,</span>
                <span class="n">param_2_maximum</span><span class="p">,</span>
                <span class="n">param_2_n_steps</span><span class="p">,</span>
                <span class="n">progress</span><span class="p">,</span>
                <span class="o">**</span><span class="n">options</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Collapse the second dimension of the results if we are doing a 1d contour</span>

            <span class="k">if</span> <span class="n">param_2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="n">cc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># With parallel computation</span>

            <span class="c1"># In order to distribute fairly the computation, the strategy is to parallelize the computation</span>
            <span class="c1"># by assigning to the engines one &quot;line&quot; of the grid at the time</span>

            <span class="c1"># Connect to the engines</span>

            <span class="n">client</span> <span class="o">=</span> <span class="n">ParallelClient</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>

            <span class="c1"># Get the number of engines</span>

            <span class="n">n_engines</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_number_of_engines</span><span class="p">()</span>

            <span class="c1"># Check whether the number of threads is larger than the number of steps in the first direction</span>

            <span class="k">if</span> <span class="n">n_engines</span> <span class="o">&gt;</span> <span class="n">param_1_n_steps</span><span class="p">:</span>

                <span class="n">n_engines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param_1_n_steps</span><span class="p">)</span>

                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;The number of engines is larger than the number of steps. Using only </span><span class="si">%s</span><span class="s2"> engines.&quot;</span>
                    <span class="o">%</span> <span class="n">n_engines</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Check if the number of steps is divisible by the number</span>
            <span class="c1"># of threads, otherwise issue a warning and make it so</span>

            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">param_1_n_steps</span><span class="p">)</span> <span class="o">%</span> <span class="n">n_engines</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Set the number of steps to an integer multiple of the engines</span>
                <span class="c1"># (note that // is the floor division, also called integer division)</span>

                <span class="n">param_1_n_steps</span> <span class="o">=</span> <span class="p">(</span><span class="n">param_1_n_steps</span> <span class="o">//</span> <span class="n">n_engines</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_engines</span>

                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Number of steps is not a multiple of the number of threads. Reducing steps to </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="n">param_1_n_steps</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Compute the number of splits, i.e., how many lines in the grid for each engine.</span>
            <span class="c1"># (note that this is guaranteed to be an integer number after the previous checks)</span>

            <span class="n">p1_split_steps</span> <span class="o">=</span> <span class="n">param_1_n_steps</span> <span class="o">//</span> <span class="n">n_engines</span>

            <span class="c1"># Prepare arrays for results</span>

            <span class="k">if</span> <span class="n">param_2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1"># One array</span>
                <span class="n">pcc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">param_1_n_steps</span><span class="p">)</span>

                <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="n">param_1_minimum</span><span class="p">,</span> <span class="n">param_1_maximum</span><span class="p">,</span> <span class="n">param_1_n_steps</span><span class="p">)</span>
                <span class="n">pb</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">pcc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">param_1_n_steps</span><span class="p">,</span> <span class="n">param_2_n_steps</span><span class="p">))</span>

                <span class="c1"># Prepare the two axes of the parameter space</span>
                <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="n">param_1_minimum</span><span class="p">,</span> <span class="n">param_1_maximum</span><span class="p">,</span> <span class="n">param_1_n_steps</span><span class="p">)</span>
                <span class="n">pb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="n">param_2_minimum</span><span class="p">,</span> <span class="n">param_2_maximum</span><span class="p">,</span> <span class="n">param_2_n_steps</span><span class="p">)</span>

            <span class="c1"># Define the parallel worker which will go through the computation</span>

            <span class="c1"># NOTE: I only divide</span>
            <span class="c1"># on the first parameter axis so that the different</span>
            <span class="c1"># threads are more or less well mixed for points close and</span>
            <span class="c1"># far from the best fit</span>

            <span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">start_index</span><span class="p">):</span>

                <span class="c1"># Re-create the minimizer</span>

                <span class="n">backup_freeParameters</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="o">.</span><span class="n">free_parameters</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="p">]</span>

                <span class="n">this_minimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_minimizer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">minus_log_like_profile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free_parameters</span>
                <span class="p">)</span>

                <span class="n">this_p1min</span> <span class="o">=</span> <span class="n">pa</span><span class="p">[</span><span class="n">start_index</span> <span class="o">*</span> <span class="n">p1_split_steps</span><span class="p">]</span>
                <span class="n">this_p1max</span> <span class="o">=</span> <span class="n">pa</span><span class="p">[(</span><span class="n">start_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">p1_split_steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

                <span class="c1"># print(&quot;From %s to %s&quot; % (this_p1min, this_p1max))</span>

                <span class="n">aa</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">ccc</span> <span class="o">=</span> <span class="n">this_minimizer</span><span class="o">.</span><span class="n">contours</span><span class="p">(</span>
                    <span class="n">param_1</span><span class="p">,</span>
                    <span class="n">this_p1min</span><span class="p">,</span>
                    <span class="n">this_p1max</span><span class="p">,</span>
                    <span class="n">p1_split_steps</span><span class="p">,</span>
                    <span class="n">param_2</span><span class="p">,</span>
                    <span class="n">param_2_minimum</span><span class="p">,</span>
                    <span class="n">param_2_maximum</span><span class="p">,</span>
                    <span class="n">param_2_n_steps</span><span class="p">,</span>
                    <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">options</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Restore best fit values</span>

                <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">backup_freeParameters</span><span class="p">,</span>
                    <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="o">.</span><span class="n">free_parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                <span class="p">):</span>

                    <span class="n">par</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span>

                <span class="k">return</span> <span class="n">ccc</span>

            <span class="c1"># Now re-assemble the vector of results taking the different parts from the engines</span>

            <span class="n">all_results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">execute_with_progress_bar</span><span class="p">(</span>
                <span class="n">worker</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_engines</span><span class="p">)),</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">these_results</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_results</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">param_2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="n">pcc</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">p1_split_steps</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">p1_split_steps</span><span class="p">]</span> <span class="o">=</span> <span class="n">these_results</span><span class="p">[</span>
                        <span class="p">:,</span> <span class="mi">0</span>
                    <span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">pcc</span><span class="p">[</span>
                        <span class="n">i</span> <span class="o">*</span> <span class="n">p1_split_steps</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">p1_split_steps</span><span class="p">,</span> <span class="p">:</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">these_results</span>

            <span class="c1"># Give the results the names that the following code expect. These are kept separate for debugging</span>
            <span class="c1"># purposes</span>

            <span class="n">cc</span> <span class="o">=</span> <span class="n">pcc</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">pa</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">pb</span>

        <span class="c1"># Here we have done the computation, in parallel computation or not. Let&#39;s make the plot</span>
        <span class="c1"># with the contour</span>

        <span class="k">if</span> <span class="n">param_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># 2d contour</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_contours</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">param_1</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">param_2</span><span class="p">,),</span> <span class="n">b</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># 1d contour (i.e., a profile)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_profile</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">param_1</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>

        <span class="c1"># Check if we found a better minimum. This shouldn&#39;t happen, but in case of very difficult fit</span>
        <span class="c1"># it might.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_minimum</span> <span class="o">-</span> <span class="n">cc</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">param_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="n">idx</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

                <span class="n">aidx</span><span class="p">,</span> <span class="n">bidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found a better minimum: </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">. Run again your fit starting from here.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">param_1</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">aidx</span><span class="p">],</span> <span class="n">param_2</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="n">bidx</span><span class="p">])</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">idx</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Found a better minimum: </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">. Run again your fit starting from here.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">param_1</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#restore model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restore_best_fit</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="JointLikelihood.plot_all_contours"><a class="viewcode-back" href="../../../notebooks/api/threeML.classicMLE.html#threeML.classicMLE.joint_likelihood.JointLikelihood.plot_all_contours">[docs]</a>    <span class="k">def</span> <span class="nf">plot_all_contours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsteps_1d</span><span class="p">,</span> <span class="n">nsteps_2d</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">log_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_errors</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nsteps_1d</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="o">.</span><span class="n">free_parameters</span><span class="p">:</span>

                <span class="n">center</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span>
                <span class="n">do_log</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,)</span>
                <span class="n">lower</span> <span class="o">=</span> <span class="n">center</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;negative_error&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_sigma</span>
                <span class="n">upper</span> <span class="o">=</span> <span class="n">center</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;positive_error&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_sigma</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">log_norm</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="o">.</span><span class="n">free_parameters</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">is_normalization</span>
                <span class="p">):</span>
                    <span class="n">do_log</span> <span class="o">=</span> <span class="p">(</span><span class="kc">True</span><span class="p">,)</span>
                    <span class="n">lower</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">center</span>
                        <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">old_div</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;negative_error&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">],</span> <span class="n">center</span><span class="p">))</span>
                        <span class="o">**</span> <span class="n">n_sigma</span>
                    <span class="p">)</span>
                    <span class="n">upper</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">center</span>
                        <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">old_div</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;positive_error&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">],</span> <span class="n">center</span><span class="p">))</span>
                        <span class="o">**</span> <span class="n">n_sigma</span>
                    <span class="p">)</span>

                <span class="n">lower</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">likelihood_model</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lower</span><span class="p">)</span>
                <span class="n">upper</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">likelihood_model</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">upper</span><span class="p">)</span>

                <span class="c1"># print param, lower, center, upper</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_contours</span><span class="p">(</span>
                        <span class="n">param</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">nsteps_1d</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">do_log</span>
                    <span class="p">)</span>
                    <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nsteps_2d</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">param_1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="o">.</span><span class="n">free_parameters</span><span class="p">:</span>

                <span class="n">do_log</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">center_1</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">][</span><span class="n">param_1</span><span class="p">]</span>
                <span class="n">lower_1</span> <span class="o">=</span> <span class="n">center_1</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;negative_error&quot;</span><span class="p">][</span><span class="n">param_1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_sigma</span>
                <span class="n">upper_1</span> <span class="o">=</span> <span class="n">center_1</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;positive_error&quot;</span><span class="p">][</span><span class="n">param_1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_sigma</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">log_norm</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="o">.</span><span class="n">free_parameters</span><span class="p">[</span><span class="n">param_1</span><span class="p">]</span><span class="o">.</span><span class="n">is_normalization</span>
                <span class="p">):</span>
                    <span class="n">do_log</span> <span class="o">=</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="n">lower_1</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">center_1</span>
                        <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">old_div</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;negative_error&quot;</span><span class="p">][</span><span class="n">param_1</span><span class="p">],</span> <span class="n">center_1</span><span class="p">))</span>
                        <span class="o">**</span> <span class="n">n_sigma</span>
                    <span class="p">)</span>
                    <span class="n">upper_1</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">center_1</span>
                        <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">old_div</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;positive_error&quot;</span><span class="p">][</span><span class="n">param_1</span><span class="p">],</span> <span class="n">center_1</span><span class="p">))</span>
                        <span class="o">**</span> <span class="n">n_sigma</span>
                    <span class="p">)</span>

                <span class="n">lower_1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_model</span><span class="p">[</span><span class="n">param_1</span><span class="p">]</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lower_1</span><span class="p">)</span>
                <span class="n">upper_1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_model</span><span class="p">[</span><span class="n">param_1</span><span class="p">]</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">upper_1</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">param_2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="o">.</span><span class="n">free_parameters</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">param_2</span> <span class="o">&lt;=</span> <span class="n">param_1</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">center_2</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">][</span><span class="n">param_2</span><span class="p">]</span>
                    <span class="n">lower_2</span> <span class="o">=</span> <span class="n">center_2</span> <span class="o">+</span> \
                        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;negative_error&quot;</span><span class="p">][</span><span class="n">param_2</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_sigma</span>
                    <span class="n">upper_2</span> <span class="o">=</span> <span class="n">center_2</span> <span class="o">+</span> \
                        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;positive_error&quot;</span><span class="p">][</span><span class="n">param_2</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_sigma</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">log_norm</span>
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="o">.</span><span class="n">free_parameters</span><span class="p">[</span>
                            <span class="n">param_2</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">is_normalization</span>
                    <span class="p">):</span>
                        <span class="n">do_log</span> <span class="o">=</span> <span class="p">(</span><span class="n">do_log</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="n">lower_2</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">center_2</span>
                            <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">old_div</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;negative_error&quot;</span><span class="p">][</span><span class="n">param_2</span><span class="p">],</span> <span class="n">center_2</span><span class="p">))</span>
                            <span class="o">**</span> <span class="n">n_sigma</span>
                        <span class="p">)</span>
                        <span class="n">upper_2</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">center_2</span>
                            <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">old_div</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;positive_error&quot;</span><span class="p">][</span><span class="n">param_2</span><span class="p">],</span> <span class="n">center_2</span><span class="p">))</span>
                            <span class="o">**</span> <span class="n">n_sigma</span>
                        <span class="p">)</span>

                    <span class="n">lower_2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_model</span><span class="p">[</span><span class="n">param_2</span><span class="p">]</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lower_2</span><span class="p">)</span>
                    <span class="n">upper_2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_model</span><span class="p">[</span><span class="n">param_2</span><span class="p">]</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">upper_2</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_contours</span><span class="p">(</span>
                            <span class="n">param_1</span><span class="p">,</span>
                            <span class="n">lower_1</span><span class="p">,</span>
                            <span class="n">upper_1</span><span class="p">,</span>
                            <span class="n">nsteps_2d</span><span class="p">,</span>
                            <span class="n">param_2</span><span class="p">,</span>
                            <span class="n">lower_2</span><span class="p">,</span>
                            <span class="n">upper_2</span><span class="p">,</span>
                            <span class="n">nsteps_2d</span><span class="p">,</span>
                            <span class="n">log</span><span class="o">=</span><span class="n">do_log</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">param_1</span><span class="p">,</span> <span class="n">param_2</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">figs</span><span class="p">,</span> <span class="n">names</span></div>

<div class="viewcode-block" id="JointLikelihood.minus_log_like_profile"><a class="viewcode-back" href="../../../notebooks/api/threeML.classicMLE.html#threeML.classicMLE.joint_likelihood.JointLikelihood.minus_log_like_profile">[docs]</a>    <span class="k">def</span> <span class="nf">minus_log_like_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">trial_values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the minus log likelihood for a given set of trial values</span>

<span class="sd">        :param trial_values: the trial values. Must be in the same number as the free parameters in the model</span>
<span class="sd">        :return: minus log likelihood</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Keep track of the number of calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ncalls</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Transform the trial values in a numpy array</span>

        <span class="n">trial_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trial_values</span><span class="p">)</span>

        <span class="c1"># Check that there are no nans within the trial values</span>

        <span class="c1"># This is the fastest way to check for any nan</span>
        <span class="c1"># (try other methods if you don&#39;t believe me)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">trial_values</span><span class="p">,</span> <span class="n">trial_values</span><span class="o">.</span><span class="n">T</span><span class="p">)):</span>
            <span class="c1"># There are nans, something weird is going on. Return FIT_FAILED so the engine</span>
            <span class="c1"># stays away from this (or fail)</span>

            <span class="k">return</span> <span class="n">minimization</span><span class="o">.</span><span class="n">FIT_FAILED</span>

        <span class="c1"># Assign the new values to the parameters</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_free_parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>

            <span class="c1"># Use the internal representation (see the Parameter class)</span>

            <span class="n">parameter</span><span class="o">.</span><span class="n">_set_internal_value</span><span class="p">(</span><span class="n">trial_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># Now profile out nuisance parameters and compute the new value</span>
        <span class="c1"># for the likelihood</span>

        <span class="n">summed_log_likelihood</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_list</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="n">this_log_like</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">inner_fit</span><span class="p">()</span>

            <span class="k">except</span> <span class="n">ModelAssertionViolation</span><span class="p">:</span>

                <span class="c1"># This is a zone of the parameter space which is not allowed. Return</span>
                <span class="c1"># a big number for the likelihood so that the fit engine will avoid it</span>

                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Fitting engine in forbidden space: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trial_values</span><span class="p">,),</span>
                <span class="p">)</span>

                <span class="k">return</span> <span class="n">minimization</span><span class="o">.</span><span class="n">FIT_FAILED</span>

            <span class="k">except</span><span class="p">:</span>

                <span class="c1"># Do not intercept other errors</span>

                <span class="k">raise</span>

            <span class="n">summed_log_likelihood</span> <span class="o">+=</span> <span class="n">this_log_like</span>

        <span class="c1"># Check that the global like is not NaN</span>
        <span class="c1"># I use this weird check because it is not guaranteed that the plugins return np.nan,</span>
        <span class="c1"># especially if they are written in something other than python</span>

        <span class="k">if</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">summed_log_likelihood</span> <span class="o">==</span> <span class="s2">&quot;nan&quot;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;These parameters returned a logLike = Nan: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">trial_values</span><span class="p">,),</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">minimization</span><span class="o">.</span><span class="n">FIT_FAILED</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;trial values: </span><span class="si">%s</span><span class="s2"> -&gt; logL = </span><span class="si">%.3f</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%.5g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">trial_values</span><span class="p">]),</span> <span class="n">summed_log_likelihood</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Record this call</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_record_calls</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">trial_values</span><span class="p">)]</span> <span class="o">=</span> <span class="n">summed_log_likelihood</span>

        <span class="c1"># Return the minus log likelihood</span>

        <span class="k">return</span> <span class="n">summed_log_likelihood</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fit_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record_calls</span><span class="p">)</span>

<div class="viewcode-block" id="JointLikelihood.set_minimizer"><a class="viewcode-back" href="../../../notebooks/api/threeML.classicMLE.html#threeML.classicMLE.joint_likelihood.JointLikelihood.set_minimizer">[docs]</a>    <span class="k">def</span> <span class="nf">set_minimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minimizer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the minimizer to be used, among those available.</span>

<span class="sd">        :param minimizer: the name of the new minimizer or an instance of a LocalMinimization or a GlobalMinimization</span>
<span class="sd">        class. Using the latter two classes allows for more choices and a better control of the details of the</span>
<span class="sd">        minimization, like the choice of algorithms (if supported by the used minimizer)</span>
<span class="sd">        :return: (none)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">minimizer</span><span class="p">,</span> <span class="n">minimization</span><span class="o">.</span><span class="n">_Minimization</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer_type</span> <span class="o">=</span> <span class="n">minimizer</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set the minimizer to </span><span class="si">{</span><span class="n">minimizer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">minimizer</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">minimization</span><span class="o">.</span><span class="n">_minimizers</span><span class="p">:</span>
                <span class="n">minimizer_list</span> <span class="o">=</span>  <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">minimization</span><span class="o">.</span><span class="n">_minimizers</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Minimizer </span><span class="si">{</span><span class="n">minimizer</span><span class="si">}</span><span class="s2"> is not available on this system. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Available minimizers: </span><span class="si">{</span><span class="n">minimizer_list</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">MinimizerNotAvailable</span><span class="p">()</span>

            <span class="c1"># The string can only specify a local minimization. This will return an error if that is not the case.</span>
            <span class="c1"># In order to setup global optimization the user needs to use the GlobalMinimization factory directly</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer_type</span> <span class="o">=</span> <span class="n">minimization</span><span class="o">.</span><span class="n">LocalMinimization</span><span class="p">(</span><span class="n">minimizer</span><span class="p">)</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set the minimizer to </span><span class="si">{</span><span class="n">minimizer</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_minimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Get an instance of the minimizer</span>

        <span class="n">minimizer_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer_type</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Call the callback if one is set</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer_callback</span><span class="p">(</span>
                <span class="n">minimizer_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">minimizer_instance</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">minimizer_in_use</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer_type</span>

<div class="viewcode-block" id="JointLikelihood.restore_best_fit"><a class="viewcode-back" href="../../../notebooks/api/threeML.classicMLE.html#threeML.classicMLE.joint_likelihood.JointLikelihood.restore_best_fit">[docs]</a>    <span class="k">def</span> <span class="nf">restore_best_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restore the model to its best fit</span>

<span class="sd">        :return: (none)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_minimizer</span><span class="o">.</span><span class="n">restore_best_fit</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Cannot restore best fit, since fit has not been executed.&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_table_of_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">max_length_of_name</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="n">current_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_of_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">current_name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">unit</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_length_of_name</span><span class="p">:</span>
                <span class="n">max_length_of_name</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_name</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
            <span class="n">rows</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="s2">&quot;Unit&quot;</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;S</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">max_length_of_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;S15&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">table</span>

    <span class="k">def</span> <span class="nf">_plot_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name1</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">cc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the likelihood profile.</span>

<span class="sd">        :param name1: Name of parameter</span>
<span class="sd">        :param a: grid for the parameter</span>
<span class="sd">        :param cc: log. likelihood values for the parameter</span>
<span class="sd">        :return: a figure containing the likelihood profile</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># plot 1,2 and 3 sigma horizontal lines</span>

        <span class="n">sigmas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

        <span class="c1"># Compute the corresponding probability. We do not</span>
        <span class="c1"># pre-compute them because we will introduce at</span>
        <span class="c1"># some point the possibility to personalize the</span>
        <span class="c1"># levels</span>

        <span class="n">probabilities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sigmas</span><span class="p">:</span>
            <span class="c1"># One-sided probability</span>
            <span class="c1"># It is one-sided because we consider one side at the time</span>
            <span class="c1"># when computing the error</span>

            <span class="n">probabilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>

        <span class="c1"># Compute the corresponding delta chisq. (chisq has 1 d.o.f.)</span>

        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="n">delta_chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="p">)</span>  <span class="c1"># two-sided!</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

        <span class="c1"># Neutralize values of the loglike too high</span>
        <span class="c1"># (fit failed)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">cc</span> <span class="o">==</span> <span class="n">minimization</span><span class="o">.</span><span class="n">FIT_FAILED</span>

        <span class="n">sub</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="o">~</span><span class="n">idx</span><span class="p">],</span> <span class="n">cc</span><span class="p">[</span><span class="o">~</span><span class="n">idx</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="n">threeML_config</span><span class="p">[</span><span class="s2">&quot;mle&quot;</span><span class="p">][</span><span class="s2">&quot;profile_color&quot;</span><span class="p">])</span>

        <span class="c1"># Now plot the failed fits as &quot;x&quot;</span>

        <span class="n">sub</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">[</span><span class="n">cc</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span> <span class="o">*</span> <span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Decide colors</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">threeML_config</span><span class="p">[</span><span class="s2">&quot;mle&quot;</span><span class="p">][</span><span class="s2">&quot;profile_level_1&quot;</span><span class="p">],</span>
            <span class="n">threeML_config</span><span class="p">[</span><span class="s2">&quot;mle&quot;</span><span class="p">][</span><span class="s2">&quot;profile_level_2&quot;</span><span class="p">],</span>
            <span class="n">threeML_config</span><span class="p">[</span><span class="s2">&quot;mle&quot;</span><span class="p">][</span><span class="s2">&quot;profile_level_3&quot;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sigmas</span><span class="p">,</span> <span class="n">delta_chi2</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_minimum</span> <span class="o">+</span> <span class="n">d</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> $\sigma$&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">,</span>
                <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Fix the axis to cover from the minimum to the 3 sigma line</span>
        <span class="n">sub</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_minimum</span> <span class="o">-</span> <span class="n">delta_chi2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_minimum</span> <span class="o">+</span> <span class="p">(</span><span class="n">delta_chi2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">sub</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">name1</span><span class="p">)</span>
        <span class="n">sub</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;-log( likelihood )&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">_plot_contours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name1</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">name2</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">cc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a contour plot.</span>

<span class="sd">        :param name1: Name of the first parameter</span>
<span class="sd">        :param a: Grid for the first parameter (dimension N)</span>
<span class="sd">        :param name2: Name of the second parameter</span>
<span class="sd">        :param b: grid for the second parameter (dimension M)</span>
<span class="sd">        :param cc: N x M matrix containing the value of the log.likelihood for each point in the grid</span>
<span class="sd">        :return: figure containing the contour</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check that we have something to plot</span>

        <span class="n">delta</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">cc</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">The maximum difference in statistic is </span><span class="si">%s</span><span class="s2"> among all the points in the grid.&quot;</span>
                <span class="o">%</span> <span class="n">delta</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot; This is too small. Enlarge the search region to display a contour plot&quot;</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># plot 1,2 and 3 sigma contours</span>
        <span class="n">sigmas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

        <span class="c1"># Compute the corresponding probability. We do not</span>
        <span class="c1"># pre-compute them because we will introduce at</span>
        <span class="c1"># some point the possibility to personalize the</span>
        <span class="c1"># levels</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sigmas</span><span class="p">:</span>
            <span class="c1"># One-sided probability</span>
            <span class="c1"># It is one-sided because we consider one side at the time</span>
            <span class="c1"># when computing the error</span>

            <span class="n">probabilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>

        <span class="c1"># Compute the corresponding delta chisq. (chisq has 2 d.o.f.)</span>
        <span class="n">delta_chi2</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>  <span class="c1"># two-sided</span>

        <span class="c1"># Boundaries for the colormap</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_minimum</span><span class="p">]</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="n">bounds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_minimum</span> <span class="o">+</span> <span class="n">delta_chi2</span><span class="p">)</span>
        <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="c1"># Define the color palette</span>
        <span class="n">palette</span> <span class="o">=</span> <span class="n">colormaps</span><span class="p">[</span><span class="n">threeML_config</span><span class="p">[</span><span class="s2">&quot;mle&quot;</span><span class="p">][</span><span class="s2">&quot;contour_cmap&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="c1"># cm.Pastel1</span>
        <span class="n">palette</span><span class="o">.</span><span class="n">set_over</span><span class="p">(</span><span class="n">threeML_config</span><span class="p">[</span><span class="s2">&quot;mle&quot;</span><span class="p">][</span><span class="s2">&quot;contour_background&quot;</span><span class="p">])</span>
        <span class="n">palette</span><span class="o">.</span><span class="n">set_under</span><span class="p">(</span><span class="n">threeML_config</span><span class="p">[</span><span class="s2">&quot;mle&quot;</span><span class="p">][</span><span class="s2">&quot;contour_background&quot;</span><span class="p">])</span>
        <span class="n">palette</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">threeML_config</span><span class="p">[</span><span class="s2">&quot;mle&quot;</span><span class="p">][</span><span class="s2">&quot;contour_background&quot;</span><span class="p">])</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

        <span class="c1"># Draw the line contours</span>
        <span class="n">sub</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
            <span class="n">b</span><span class="p">,</span>
            <span class="n">a</span><span class="p">,</span>
            <span class="n">cc</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_minimum</span> <span class="o">+</span> <span class="n">delta_chi2</span><span class="p">,</span>
            <span class="n">colors</span><span class="o">=</span><span class="p">(</span>
                <span class="n">threeML_config</span><span class="p">[</span><span class="s2">&quot;mle&quot;</span><span class="p">][</span><span class="s2">&quot;contour_level_1&quot;</span><span class="p">],</span>
                <span class="n">threeML_config</span><span class="p">[</span><span class="s2">&quot;mle&quot;</span><span class="p">][</span><span class="s2">&quot;contour_level_2&quot;</span><span class="p">],</span>
                <span class="n">threeML_config</span><span class="p">[</span><span class="s2">&quot;mle&quot;</span><span class="p">][</span><span class="s2">&quot;contour_level_3&quot;</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Set the axes labels</span>

        <span class="n">sub</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">name2</span><span class="p">)</span>
        <span class="n">sub</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">name1</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span>

<div class="viewcode-block" id="JointLikelihood.compute_TS"><a class="viewcode-back" href="../../../notebooks/api/threeML.classicMLE.html#threeML.classicMLE.joint_likelihood.JointLikelihood.compute_TS">[docs]</a>    <span class="k">def</span> <span class="nf">compute_TS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_name</span><span class="p">,</span> <span class="n">alt_hyp_mlike_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the Likelihood Ratio Test statistic (TS) for the provided source</span>

<span class="sd">        :param source_name: name for the source</span>
<span class="sd">        :param alt_hyp_mlike_df: likelihood dataframe (it is the second output of the .fit() method)</span>
<span class="sd">        :return: a DataFrame containing the null hypothesis and the alternative hypothesis -log(likelihood) values and</span>
<span class="sd">        the value for TS for the source for each loaded dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">source_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Source </span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2"> is not in the current model&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Clone model</span>
        <span class="n">model_clone</span> <span class="o">=</span> <span class="n">clone_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="p">)</span>

        <span class="c1"># Remove this source from the model</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">model_clone</span><span class="o">.</span><span class="n">remove_source</span><span class="p">(</span><span class="n">source_name</span><span class="p">)</span>
        <span class="c1">#import copy</span>
        <span class="c1">#data_list_clone = copy.deepcopy(self._data_list)</span>

        <span class="c1"># Fit</span>
        <span class="n">another_jl</span> <span class="o">=</span> <span class="n">JointLikelihood</span><span class="p">(</span><span class="n">model_clone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_list</span><span class="p">)</span>

        <span class="c1"># Use the same minimizer as the parent object</span>
        <span class="n">another_jl</span><span class="o">.</span><span class="n">set_minimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minimizer_in_use</span><span class="p">)</span>

        <span class="c1"># We do not need the covariance matrix, just the likelihood value</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">null_hyp_mlike_df</span> <span class="o">=</span> <span class="n">another_jl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_covariance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="c1"># Compute TS for all datasets</span>
        <span class="n">TSs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">alt_hyp_mlikes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">null_hyp_mlikes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_list</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>

            <span class="n">this_name</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">name</span>

            <span class="n">null_hyp_mlike</span> <span class="o">=</span> <span class="n">null_hyp_mlike_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">this_name</span><span class="p">,</span>
                                                   <span class="s2">&quot;-log(likelihood)&quot;</span><span class="p">]</span>
            <span class="n">alt_hyp_mlike</span> <span class="o">=</span> <span class="n">alt_hyp_mlike_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">this_name</span><span class="p">,</span> <span class="s2">&quot;-log(likelihood)&quot;</span><span class="p">]</span>

            <span class="n">this_TS</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">null_hyp_mlike</span> <span class="o">-</span> <span class="n">alt_hyp_mlike</span><span class="p">)</span>

            <span class="n">TSs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_TS</span><span class="p">)</span>
            <span class="n">alt_hyp_mlikes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alt_hyp_mlike</span><span class="p">)</span>
            <span class="n">null_hyp_mlikes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">null_hyp_mlike</span><span class="p">)</span>

        <span class="n">TS_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="n">TS_df</span><span class="p">[</span><span class="s2">&quot;Null hyp.&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">null_hyp_mlikes</span>
        <span class="n">TS_df</span><span class="p">[</span><span class="s2">&quot;Alt. hyp.&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alt_hyp_mlikes</span>
        <span class="n">TS_df</span><span class="p">[</span><span class="s2">&quot;TS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TSs</span>

        <span class="c1"># Reassign the original likelihood model to the datasets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_model_to_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_likelihood_model</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TS_df</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017--2021, G.Vianello, J. M. Burgess, N. Di Lalla, N. Omodei, H. Fleischhack.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fitting XMM-Newton data with the APEC model &mdash; The Multi-Mission Maximum Likelihood framework  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
      <link rel="stylesheet" type="text/css" href="../_static/dark_mode_css/general.css" />
      <link rel="stylesheet" type="text/css" href="../_static/dark_mode_css/dark.css" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="../_static/dark_mode_js/default_dark.js"></script>
        <script src="../_static/dark_mode_js/theme_switcher.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Example joint fit between GBM and Swift BAT" href="joint_BAT_gbm_demo.html" />
    <link rel="prev" title="Analyzing GRB 080916C" href="grb080916C.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            The Multi-Mission Maximum Likelihood framework
              <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../team.html">Project &amp; Team</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Intro</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging and Verbosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xspec_users.html">Notes for XSPEC Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="Minimization_tutorial.html">Minimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="Bayesian_tutorial.html">Bayesian Posterior Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="sampler_docs.html">Bayesian Sampler Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modeling.html">Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/API.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/API.html#threeml">threeML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release Notes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Features and examples:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Analysis_results_showcase.html">Analysis Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="random_variates.html">Random Variates</a></li>
<li class="toctree-l1"><a class="reference internal" href="Point_source_plotting.html">Point source plotting basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="Building_Plugins_from_TimeSeries.html">Constructing plugins from TimeSeries</a></li>
<li class="toctree-l1"><a class="reference internal" href="grb080916C.html">Analyzing GRB 080916C</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Fitting XMM-Newton data with the APEC model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Setting-up-pyatomdb">Setting up pyatomdb</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Loading-the-APEC-model">Loading the APEC model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Comparison-with-XSPEC">Comparison with XSPEC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="joint_BAT_gbm_demo.html">Example joint fit between GBM and Swift BAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="joint_fitting_xrt_and_gbm_xspec_models.html">Joint fitting XRT and GBM data with XSPEC models</a></li>
<li class="toctree-l1"><a class="reference internal" href="flux_examples.html">Point Source Fluxes and Multiple Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="Fermipy_LAT.html">Fermi-LAT via FermiPyLike</a></li>
<li class="toctree-l1"><a class="reference internal" href="LAT_Transient_Builder_Example.html">Analysis of GRB 190114C with Fermi-LAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="Time-energy-fit.html">Time-energy fit</a></li>
<li class="toctree-l1"><a class="reference internal" href="synthetic_spectra.html">Generating Synthetic Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="gof_lrt.html">Goodness of Fit and Model Comparison</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Multi-Mission Maximum Likelihood framework</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Fitting XMM-Newton data with the APEC model</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Fitting-XMM-Newton-data-with-the-APEC-model">
<h1>Fitting XMM-Newton data with the APEC model<a class="headerlink" href="#Fitting-XMM-Newton-data-with-the-APEC-model" title="Permalink to this heading"></a>
</h1>
<p>The Astrophysical Plasma Emission Code (APEC, <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2001ApJ...556L..91S/abstract">Smith et al. 2001</a>) is a state-of-the-art code to model the X-ray emission of optically thin astrophysical plasma in collisional equilibrium. APEC has been widely used in the literature to study the spectra of a wide variety of sources, such as galaxy clusters and groups, supernova remnants, or stellar coronae. The code self-consistently models the continuum (bremsstrahlung) emission
as well as the pseudo-continuum and over 10,000 individual emission lines.</p>
<p>Astromodels includes a native Python implementation of APEC based on <code class="docutils literal notranslate"><span class="pre">`pyatomdb</span></code> &lt;<a class="reference external" href="https://atomdb.readthedocs.io/en/master/">https://atomdb.readthedocs.io/en/master/</a>&gt;`__. As the model is only available when an installation of <code class="docutils literal notranslate"><span class="pre">pyatomdb</span></code> can be found, the user must make sure <code class="docutils literal notranslate"><span class="pre">pyatomdb</span></code> is installed and the required atomic data files have been downloaded.</p>
<section id="Setting-up-pyatomdb">
<h2>Setting up pyatomdb<a class="headerlink" href="#Setting-up-pyatomdb" title="Permalink to this heading"></a>
</h2>
<p><code class="docutils literal notranslate"><span class="pre">pyatomdb</span></code> is easily installable using pip:</p>
<div class="highlight-none notranslate">
<div class="highlight"><pre><span></span>$] pip install pyatomdb
</pre></div>
</div>
<p>When running the code for the first time, the user will be requested to download the ATOMDB database locally</p>
<div class="highlight-none notranslate">
<div class="highlight"><pre><span></span>$] python -c "import pyatomdb"
</pre></div>
</div>
<p>This command will prompt the user to choose a directory to store the atomic data (usually <code class="docutils literal notranslate"><span class="pre">$HOME/atomdb</span></code>). Once the data have been downloaded, the ATOMDB environment variable must be set to indicate the location of the atomic data</p>
<div class="highlight-none notranslate">
<div class="highlight"><pre><span></span>$] export ATOMDB=$HOME/atomdb
</pre></div>
</div>
<p>OK, we’re all set!</p>
</section>
<section id="Loading-the-APEC-model">
<h2>Loading the APEC model<a class="headerlink" href="#Loading-the-APEC-model" title="Permalink to this heading"></a>
</h2>
<p>Once <code class="docutils literal notranslate"><span class="pre">pyatomdb</span></code> is properly installed, it is available as a “Function1D” object</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate">
<div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate">
<div class="highlight"><pre><span></span><span class="o">%%capture</span>

<span class="kn">from</span> <span class="nn">threeML</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">modapec</span> <span class="o">=</span> <span class="n">APEC</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>The intensity of the various lines in the model is set relative to the Solar abundance. Therefore, one must set the Solar abundance table to predict the line intensity, using the <code class="docutils literal notranslate"><span class="pre">init_session</span></code> method of the APEC class. By default, i.e. if the <code class="docutils literal notranslate"><span class="pre">init_session</span></code> method is ran with no argument, the code defaults to <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1989GeCoA..53..197A/abstract">Anders &amp; Grevesse (1989)</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate">
<div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate">
<div class="highlight"><pre><span></span><span class="n">modapec</span><span class="o">.</span><span class="n">init_session</span><span class="p">(</span><span class="n">abund_table</span><span class="o">=</span><span class="s1">'AG89'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Will not thermally broaden lines
</pre></div>
</div>
</div>
<p>If, for instance, we wish to initialize the APEC model to use the <a class="reference external" href="https://www.lpi.usra.edu/meetings/metsoc2009/pdf/5154.pdf">Lodders &amp; Palme (2009)</a> table, we pass</p>
<div class="highlight-none notranslate">
<div class="highlight"><pre><span></span>modapec.init_session(abund_table='Lodd09')
</pre></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate">
<div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate">
<div class="highlight"><pre><span></span><span class="n">modapec</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<ul>

<li>description: The Astrophysical Plasma Emission Code (APEC, Smith et al. 2001) contributed by Dominique Eckert</li>

<li>formula: $n.a.$</li>

<li>parameters:
<ul>

<li>K:
<ul>

<li>value: 1.0</li>

<li>desc: Normalization in units of 1e-14/(4*pi*(1+z)^2*dA*2)*EM</li>

<li>min_value: 1e-30</li>

<li>max_value: 1000.0</li>

<li>unit: </li>

<li>is_normalization: True</li>

<li>delta: 0.1</li>

<li>free: True</li>

</ul>

</li>

<li>kT:
<ul>

<li>value: 1.0</li>

<li>desc: Plasma temperature</li>

<li>min_value: 0.08</li>

<li>max_value: 64.0</li>

<li>unit: </li>

<li>is_normalization: False</li>

<li>delta: 0.1</li>

<li>free: True</li>

</ul>

</li>

<li>abund:
<ul>

<li>value: 1.0</li>

<li>desc: Metal abundance</li>

<li>min_value: 0.0</li>

<li>max_value: 5.0</li>

<li>unit: </li>

<li>is_normalization: False</li>

<li>delta: 0.01</li>

<li>free: False</li>

</ul>

</li>

<li>redshift:
<ul>

<li>value: 0.1</li>

<li>desc: Source redshift</li>

<li>min_value: 0.0</li>

<li>max_value: 10.0</li>

<li>unit: </li>

<li>is_normalization: False</li>

<li>delta: 0.001</li>

<li>free: False</li>

</ul>

</li>

</ul>

</li>

</ul>
</div>
</div>
<p>The parameters of the model are set in the following way</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate">
<div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate">
<div class="highlight"><pre><span></span><span class="n">modapec</span><span class="o">.</span><span class="n">kT</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="c1"># 3 keV temperature</span>

<span class="n">modapec</span><span class="o">.</span><span class="n">K</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="c1"># Normalization, proportional to emission measure</span>

<span class="n">modapec</span><span class="o">.</span><span class="n">redshift</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c1"># Source redshift</span>

<span class="n">modapec</span><span class="o">.</span><span class="n">abund</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="c1"># The metal abundance of each element is set to 0.3 times the Solar abundance</span>
</pre></div>
</div>
</div>
<p>Now let’s see how the model depends on the input temperature…</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate">
<div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># Set up the energy grid</span>

<span class="n">ktgrid</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">7.0</span><span class="p">,</span><span class="mf">9.0</span><span class="p">,</span><span class="mf">12.0</span><span class="p">,</span><span class="mf">15.0</span><span class="p">]</span> <span class="c1"># Temperature grid</span>
<br></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate">
<div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">colors</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cmx</span>

<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">])</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
    <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>

<span class="n">nspec</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ktgrid</span><span class="p">)</span>

<span class="n">values</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspec</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">'gist_rainbow'</span><span class="p">)</span>
<span class="n">cNorm</span>  <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">scalarMap</span> <span class="o">=</span> <span class="n">cmx</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">cNorm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)</span>
<span class="n">ccc</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspec</span><span class="p">):</span>
    <span class="n">ccc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scalarMap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspec</span><span class="p">):</span>
    <span class="n">modapec</span><span class="o">.</span><span class="n">kT</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">ktgrid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span><span class="n">modapec</span><span class="p">(</span><span class="n">energies</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="n">ccc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">'kT=</span><span class="si">%g</span><span class="s1"> keV'</span><span class="o">%</span><span class="p">(</span><span class="n">ktgrid</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">'log'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">'log'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Energy [keV]'</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Photon Flux'</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">15.</span><span class="p">,</span><span class="mf">1e-8</span><span class="p">,</span><span class="mf">1.0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Z=0.3 $Z_\odot$ and varying temperature'</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<br></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate">
<div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f4927f66940&gt;
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 432x288 with 0 Axes&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_APEC_doc_12_2.png" src="../_images/notebooks_APEC_doc_12_2.png">
</div>
</div>
<p>Now let’s see how the model depends on metallicity for a temperature of 1 keV…</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate">
<div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate">
<div class="highlight"><pre><span></span><span class="n">Zgrid</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">]</span> <span class="c1"># Metallicities wrt Solar</span>

<span class="n">modapec</span><span class="o">.</span><span class="n">kT</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate">
<div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate">
<div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">])</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
    <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>

<span class="n">nspec</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Zgrid</span><span class="p">)</span>

<span class="n">values</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspec</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">'gist_rainbow'</span><span class="p">)</span>
<span class="n">cNorm</span>  <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">scalarMap</span> <span class="o">=</span> <span class="n">cmx</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">cNorm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)</span>
<span class="n">ccc</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspec</span><span class="p">):</span>
    <span class="n">ccc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scalarMap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspec</span><span class="p">):</span>
    <span class="n">modapec</span><span class="o">.</span><span class="n">abund</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">Zgrid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span><span class="n">modapec</span><span class="p">(</span><span class="n">energies</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="n">ccc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">'$Z/Z_\odot$=</span><span class="si">%g</span><span class="s1">'</span><span class="o">%</span><span class="p">(</span><span class="n">Zgrid</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">'log'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">'log'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Energy [keV]'</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Photon Flux'</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">15.</span><span class="p">,</span><span class="mf">1e-7</span><span class="p">,</span><span class="mf">0.1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'kT=1 keV and varying metallicity'</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
<br></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate">
<div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f494f7edee0&gt;
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 432x288 with 0 Axes&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_APEC_doc_15_2.png" src="../_images/notebooks_APEC_doc_15_2.png">
</div>
</div>
</section>
<section id="Comparison-with-XSPEC">
<h2>Comparison with XSPEC<a class="headerlink" href="#Comparison-with-XSPEC" title="Permalink to this heading"></a>
</h2>
<p>To test the implementation, let’s simulate a spectrum with XSPEC and fit it within 3ML using the APEC model. We simulate an <em>XMM-Newton</em>/EPIC-pn spectrum with a temperature of 5 keV, a metallicity of 0.3 Solar, a normalization of unity and a redshift of 0.1. The simulated model is absorbed by photo-electric absorption (PhAbs model) with a column density of <span class="math notranslate nohighlight">\(10^{21}\)</span> cm<span class="math notranslate nohighlight">\(^{-2}\)</span>. We start by declaring the model,</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate">
<div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate">
<div class="highlight"><pre><span></span><span class="n">phabs</span> <span class="o">=</span> <span class="n">PhAbs</span><span class="p">()</span>

<span class="n">phabs</span><span class="o">.</span><span class="n">NH</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># A value of 1 corresponds to 1e22 cm-2</span>

<span class="n">phabs</span><span class="o">.</span><span class="n">NH</span><span class="o">.</span><span class="n">fix</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># NH is fixed</span>

<span class="n">phabs</span><span class="o">.</span><span class="n">init_xsect</span><span class="p">(</span><span class="n">abund_table</span><span class="o">=</span><span class="s1">'AG89'</span><span class="p">)</span>

<span class="n">modapec</span><span class="o">.</span><span class="n">kT</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="c1"># Initial values</span>

<span class="n">modapec</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="n">modapec</span><span class="o">.</span><span class="n">redshift</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="n">modapec</span><span class="o">.</span><span class="n">abund</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="n">mod_comb</span> <span class="o">=</span> <span class="n">phabs</span> <span class="o">*</span> <span class="n">modapec</span>
</pre></div>
</div>
</div>
<p>Now we load the simulated spectrum in 3ML…</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate">
<div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate">
<div class="highlight"><pre><span></span><span class="n">xmm_pha</span> <span class="o">=</span> <span class="n">get_path_of_data_file</span><span class="p">(</span><span class="s2">"datasets/xmm/pnS004-A2443_reg2.fak"</span><span class="p">)</span>
<span class="n">xmm_rmf</span> <span class="o">=</span> <span class="n">get_path_of_data_file</span><span class="p">(</span><span class="s2">"datasets/xmm/pnS004-A2443_reg2.rmf"</span><span class="p">)</span>
<span class="n">xmm_arf</span> <span class="o">=</span> <span class="n">get_path_of_data_file</span><span class="p">(</span><span class="s2">"datasets/xmm/pnS004-A2443_reg2.arf"</span><span class="p">)</span>

<span class="n">ogip</span> <span class="o">=</span> <span class="n">OGIPLike</span><span class="p">(</span><span class="s2">"ogip"</span><span class="p">,</span> <span class="n">observation</span><span class="o">=</span><span class="n">xmm_pha</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">xmm_rmf</span><span class="p">,</span> <span class="n">arf_file</span><span class="o">=</span><span class="n">xmm_arf</span><span class="p">)</span>

<span class="n">pts</span> <span class="o">=</span> <span class="n">PointSource</span><span class="p">(</span><span class="s1">'mysource'</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">spectral_shape</span><span class="o">=</span><span class="n">mod_comb</span><span class="p">)</span>
<br></pre></div>
</div>
</div>
<p>Let’s have a look at the loaded spectrum…</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate">
<div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate">
<div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">ogip</span><span class="o">.</span><span class="n">view_count_spectrum</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="mf">14.</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Energy [keV]'</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Rate [counts s$^{-1}$ keV$^{-1}$]'</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
<br><br></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_APEC_doc_21_0.png" src="../_images/notebooks_APEC_doc_21_0.png">
</div>
</div>
<p>Here we set up the likelihood and fit the data</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate">
<div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate">
<div class="highlight"><pre><span></span><span class="n">ogip</span><span class="o">.</span><span class="n">remove_rebinning</span><span class="p">()</span>

<span class="n">ogip</span><span class="o">.</span><span class="n">set_active_measurements</span><span class="p">(</span><span class="s1">'0.5-10.'</span><span class="p">)</span>

<span class="n">ogip</span><span class="o">.</span><span class="n">rebin_on_source</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>

<span class="n">jl</span> <span class="o">=</span> <span class="n">JointLikelihood</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">DataList</span><span class="p">(</span><span class="n">ogip</span><span class="p">))</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">jl</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<br></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best fit values:

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>result</th>
      <th>unit</th>
    </tr>
    <tr>
      <th>parameter</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mysource.spectrum.main.composite.K_2</th>
      <td>(9.8742 +/- 0.0033) x 10^-1</td>
      <td>1 / (cm2 keV s)</td>
    </tr>
    <tr>
      <th>mysource.spectrum.main.composite.kT_2</th>
      <td>5.019 +/- 0.005</td>
      <td>keV</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Correlation matrix:

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<table id="table139951876078992">
<tr>
<td>1.00</td>
<td>-0.30</td>
</tr>
<tr>
<td>-0.30</td>
<td>1.00</td>
</tr>
</table>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Values of -log(likelihood) at the minimum:

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>-log(likelihood)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>ogip</th>
      <td>9682.695868</td>
    </tr>
    <tr>
      <th>total</th>
      <td>9682.695868</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Values of statistical measures:

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>statistical measures</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AIC</th>
      <td>19369.398043</td>
    </tr>
    <tr>
      <th>BIC</th>
      <td>19380.497261</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>The fitted values are within 1% of the input ones from XSPEC, showing that the native 3ML implementation is accurate. We can visualize the fit in the following way</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate">
<div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate">
<div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">display_spectrum_model_counts</span><span class="p">(</span><span class="n">jl</span><span class="p">,</span><span class="n">data_color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span><span class="n">model_color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">min_rate</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<br></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_APEC_doc_25_0.png" src="../_images/notebooks_APEC_doc_25_0.png">
</div>
</div>
</section>
</section>



           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="grb080916C.html" class="btn btn-neutral float-left" title="Analyzing GRB 080916C" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="joint_BAT_gbm_demo.html" class="btn btn-neutral float-right" title="Example joint fit between GBM and Swift BAT" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright (2024), the ThreeML developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>